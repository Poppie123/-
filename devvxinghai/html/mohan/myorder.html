<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>我的-我的订单页面</title>
    <!-- <link rel="stylesheet" href="../../css/hui.css"> -->
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_1380959_lp9c1mv9ir.css">
    <link rel="stylesheet" href="../../css/common.css">
    <script src="../../js/rem.js"></script>
    <style>
        html,
        body {
            height: 100%;
            background-color: #F8F9FB;
        }

        .header {
            width: 7.5rem;
            height: .93rem;
            background-color: #FFFFFF;
            padding: 0 .3rem;
            position: fixed;
            top: 0;
            z-index: 1300;
        }

        .header .iconfanhui {
            font-size: .3rem;
            color: #333333;
            float: left;
        }

        .header .order {
            font-size: .36rem;
            font-weight: bold;
            color: #333333;
            text-align: center;
            position: relative;
        }
        .header .myhead{
            width: .3rem;
            height: .3rem;
        }
        .header .order .iconsanjiaoxing-copy {
            position: absolute;
            top: 0;
            font-size: .5rem;
            color: #333333;
        }

        .biaoti {
            width: 100%;
            height: .88rem;
            line-height: .88rem;
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
            padding-left: .31rem;
            padding-right: .31rem;
            background-color: #FFFFFF;
            position: fixed;
            top: .88rem;
            z-index: 1100;
        }

        .biaoti .all {
            display: inline-block;
            font-size: .32rem;
            color: #999999;
            text-align: left;
            margin-right: .3rem;
        } 
        .biaoti .all:last-child {
            margin-right: 0;
        } 
        .active {
            color: #0086F7!important;
        }

        .middle {
            width: 7.5rem;
            padding-left: .3rem;
            padding-right: .3rem;
            margin-bottom: .5rem;
            padding-top: 1.76rem; 
        }

        .middle .main {
            width: 6.9rem;
            /* height: 3.97rem; */
            background-color: #FFFFFF;
            padding: .3rem;
            overflow: hidden;
            margin-bottom: .3rem;
        }

        .middle .main .main-title {
            font-size: .28rem;
            color: #999999;
            text-align: left;
            overflow: hidden;
        }

        .middle .main .main-title .time {
            float: left;
        }

        .middle .main .main-title .paid {
            float: right;
        }

        .middle .main .main-center {
            height: 2.2rem;
            margin-top: .2rem;
            overflow: hidden;
            border-bottom: 1px solid #EEEEEE;
        }

        .middle .main .main-center img {
            width: 2.5rem;
            height: 1.85rem;
            border-radius: .05rem;
            float: left;
            /* margin-right: .2rem; */
        }

        .middle .main .main-center .right {
            margin-left: .15rem;
            float: left;
            overflow: hidden;

        }

        .middle .main .main-center .right .right-title {
            width: 3.62rem;
            font-size: .28rem;
            font-weight: bold;
            color: #333333;
            text-align: left;
            overflow: hidden;
        }

        .middle .main .main-center .right .right-price {
            margin-top: .55rem;
            overflow: hidden;
        }

        .middle .main .main-center .right .right-price .fahuo {
            font-size: .24rem;
            color: #999999;
            text-align: left;
            float: left;
        }

        .middle .main .main-center .right .right-price .num {
            font-size: .2rem;
            color: #333333;
            text-align: left;
            float: right;
            position: relative;
            top:-0.04rem;
        }

        .middle .main .main-center .right .right-price .num .three {
            font-size: .28rem;
        }

        .heji {
            width: 100%;
            height: .89rem;
            text-align: right;
            overflow: hidden;
            font-size: .28rem;
            color: #333333;
            text-align: left;
        }

        .heji .sum {
            margin-left: .15rem;
        }

        .heji .sum span {
            color: #FF0000;
        }
        .middle .main  .btns{
            width: 100%;
            overflow: hidden;
            padding: 0 0 .2rem;
        }
        .middle .main .btns .cancel{
            width: 1.7rem;
            height: .52rem;
            font-size: .32rem;
            color: #333333;
            text-align: center;
            border: 1px solid #AAAAAA;
            border-radius: .3rem;
            float: right;
            }
        .middle .main .btns .paidmoney{
            width: 1.7rem;
            height: .52rem;
            font-size: .32rem;
            color: #0086F7;
            text-align: center;
            border: 1px solid #0086F7;
            border-radius: .3rem;
            margin-left: .3rem;
            float: right;
        }
        .mask{
            width: 100%;
            height: 100%;
            background: #000;
            opacity: .65;
            position: fixed;
            left: 0;
            top: 0;
        }
        .header_nav {
            width: 100%;
            height: 0;
            position: fixed;
            top: -2.81rem;
            z-index: 1500;
            padding: 0 1.07rem;
            background-color: #fff;
            overflow: hidden;
            transition: .4s;
        }
        .header_nav .header_item {
            width: 2rem;
            height: .72rem;
            font-size: .32rem;
            font-weight: 400;
            color: #333;
            background: rgba(248, 249, 251, 1);
            border-radius: .10rem;
            text-align: center;
            line-height: .72rem;
            margin-top: .3rem;
        }
        /* 激活 */
        .header_nav .hdactive {
            font-weight: bold;
            color: #fff;
            background: #0086F7;
            /* background: rgba(0, 134, 247, 1); */
        }
        /* 店铺相关 */
        .shop-item{
            width: 100%;
            height: auto;
            background-color: #fff;
            border-radius: .2rem;
            margin-bottom: .2rem;
        }
        .shop-name{
            width: 100%;
            height: .8rem;
            border-bottom: 1px solid #eee;
            padding: 0 .3rem;
        }
        .shop-name .iconfont{
            font-size: .36rem;
            color:#333;
        }
        .shop-name .icongengduo{
            font-size: .26rem;
            color: #eee;
        }
        .shop-name span{
            font-size: .3rem;
            color:#333;
            margin: 0 .2rem;
        }
    </style>
</head>

<body>
    <div id="root" v-cloak>
        <v-loading v-show="loading" :opt="opt"></v-loading>
        <no-data v-show="nodata"></no-data>
    <div class="header flex align-items space-between" >
        <i class="iconfont iconfanhui " @click="back"></i>
        <div class="order" v-if="headerNavType == 3 || headerNavType == -1" @click="openHeaderNav">我的订单<i class="iconfont iconsanjiaoxing-copy"></i></div>
        <div class="order" v-if="headerNavType == 2 " @click="openHeaderNav">健康服务订单<i class="iconfont iconsanjiaoxing-copy"></i></div>
        <div class="order" v-if="headerNavType == 1 " @click="openHeaderNav">旅游订单<i class="iconfont iconsanjiaoxing-copy"></i></div>
        <div class="order" v-if="headerNavType == 0 " @click="openHeaderNav">旅居卡订单<i class="iconfont iconsanjiaoxing-copy"></i></div>
        <div class="myhead"></div>
    </div>
    <div class="header_nav flex space-around flex_wrap" :style="{height:hdNavTop}" >
        <div class="header_item" :class="{hdactive:headerNavType == 0}" @click="changeHeaderNav(0)">旅居卡</div>
        <div class="header_item" :class="{hdactive:headerNavType == 1}" @click="changeHeaderNav(1)">旅游服务</div>
        <div class="header_item" :class="{hdactive:headerNavType == 2}" @click="changeHeaderNav(2)">健康服务</div>
        <div class="header_item" :class="{hdactive:headerNavType == 3}" @click="changeHeaderNav(3)">其它</div>
    </div>
    <div class="mask" v-show="headerNavBox" @click="closeHeaderNav"></div>
    <div class="biaoti " v-show="headerNavType == 3 || headerNavType == -1">
        <div class="all" :class="{active:currentOrderType == 0}" @click="changeOrderType(0)">全部</div>
        <div class="all" :class="{active:currentOrderType == 1}" @click="changeOrderType(1)">待付款</div>
        <div class="all" :class="{active:currentOrderType == 2}" @click="changeOrderType(2)">待发货</div>
        <div class="all" :class="{active:currentOrderType == 3}" @click="changeOrderType(3)">待收货</div>
        <div class="all" :class="{active:currentOrderType == 4}" @click="changeOrderType(4)">待评价</div>
        <div class="all" :class="{active:currentOrderType == 5}" @click="changeOrderType(5)">退款/售后</div>
    </div>
    <div class="biaoti flex space-between align-items" v-show="headerNavType == 2 || headerNavType == 1">
        <div class="all" :class="{active:currentOrderType == 0}" @click="changeOrderType(0)">全部</div>
        <div class="all" :class="{active:currentOrderType == 1}" @click="changeOrderType(1)">待付款</div>
        <div class="all" :class="{active:currentOrderType == 2}" @click="changeOrderType(2)">待核销</div>
        <div class="all" :class="{active:currentOrderType == 3}" @click="changeOrderType(3)">待评价</div>
        <div class="all" :class="{active:currentOrderType == 4}" @click="changeOrderType(4)">退款/售后</div>
    </div>
    <div class="biaoti flex space-between align-items" v-show="headerNavType == 0">
        <div class="all" :class="{active:currentOrderType == 0}" @click="changeOrderType(0)">全部</div>
        <div class="all" :class="{active:currentOrderType == 1}" @click="changeOrderType(1)">待付款</div>
        <div class="all" :class="{active:currentOrderType == 2}" @click="changeOrderType(2)">制卡中</div>
        <div class="all" :class="{active:currentOrderType == 3}" @click="changeOrderType(3)">已发货</div>
        <div class="all" :class="{active:currentOrderType == 4}" @click="changeOrderType(4)">已完成</div>
    </div>
    <div class="middle">
        <!-- <div class="shop-item">
            <div class="shop-name flex align-items flex flex-start" >
                <i class="iconfont iconxingzhuang4"></i>
                <span>店铺A</span>
                <i class="iconfont icongengduo"></i>
            </div> -->
            <div class="main" v-for="(item,index) in orderList" @click="openOrderDtl(index)">
                <!-- 普通订单 -->
                <div class="main-title" v-if="item.order_type == 4">
                    <span class="time">{{ item.add_time }}</span>
                    <span class="paid active" v-if="item.pay_status == 0 && item.order_status != 2">待支付</span>
                    <span class="paid active" v-else-if="item.pay_status==1 && item.order_status==1 && item.shopping_status == 0" >待发货</span>
                    <span class="paid active" v-else-if="item.shipping_status == 1  && item.order_status == 1">待收货</span>
                    <span class="paid active" v-else-if="item.order_status == 2 ">已取消</span>
                    <span class="paid active" v-else-if="item.order_status == 3">退款中</span>
                    <span class="paid active" v-else-if="item.order_status == 4">退货中</span>
                    <span class="paid active" v-else-if="item.order_status == 5">已退款</span>
                    <span class="paid active" v-else-if="item.order_status == 6">已退货</span>
                    <span class="paid active" v-else-if="item.order_status == 7">待评价</span>
                    <span class="paid active" v-else-if="item.order_status == 8">已完成</span>
                </div>
                <!-- 旅居卡 -->
                <div class="main-title" v-if="item.order_type == 1">
                    <span class="time">{{ item.add_time }}</span>
                    <span class="paid active" v-if="item.pay_status == 0 && item.order_status != 2">待支付</span>
                    <span class="paid active" v-else-if="item.order_status == 1 && item.pay_status==1 && item.shipping_status !== 2">制卡中</span>
                    <span class="paid active" v-else-if="item.pay_status == 1 && item.shipping_status == 2" >待核销</span>
                    <span class="paid active" v-else-if="item.order_status == 8">已完成</span>
                </div>
                <!-- 旅游产品 -->
                <div class="main-title" v-if="item.order_type == 2 || item.order_type == 3">
                    <span class="time">{{ item.add_time }}</span>
                    <span class="paid active" v-if="item.pay_status == 0 && item.order_status != 2">待付款</span>
                    <span class="paid active" v-else-if="item.pay_status == 1 && item.order_status == 1">待核销</span>
                    <span class="paid active" v-else-if="item.order_status == 7">待评价</span>
                    <span class="paid active" v-else-if="item.order_status == 2 || item.order_status == 3 || item.order_status == 4 || item.order_status == 5 || item.order_status == 6">退款售后</span>
                    <span class="paid active" v-else-if="item.order_status == 8">已完成</span>
                </div>
                <div class="main-center" v-for="v in item.order_goods">
                    <img v-if="index > 4" src="../../image/zhanweiLv.png" class="hui-lazy" :lazySrc="v.goods_img"/>
                    <img v-else :src="v.goods_img"  />
                    <!-- <img :src="v.goods_img" alt=""> -->
                    <div class="right">
                        <div class="right-title ellipsis2">{{ v.goods_name }}</div>
                        <div class="right-price">
                            <span class="fahuo">{{ v.goods_attr}}</span>
                            <span class="num">x<span class="three">{{ v.goods_number }}</span></span>
                        </div>
                    </div>
                </div>
                <div class="heji flex flex_end align-items">
                    共{{ item.order_total_num }}件商品<span class="sum">合计<span>￥{{ item.order_total_money }}</span></span>
                </div>
                <div class="btns">
                    <div class="paidmoney" v-if="item.pay_status == 0 && item.order_status != 2 && currentOrderType != 0" @click.stop="btnOpt(1,index)">去付款</div>
                    <div class="cancel" v-if="item.pay_status == 0 && item.order_status != 2 && currentOrderType != 0" @click.stop="btnOpt(2,index)">取消订单</div>
                    <div class="paidmoney" v-if="item.shipping_status == 1 && currentOrderType != 0" @click.stop="btnOpt(3,index)">确认收货</div>
                    <div class="cancel"  @click.stop="btnOpt(4,index)">删除订单</div>
                </div>
            </div>
        <!-- </div> -->
       
    </div> 
    </div>
    <script src="../../js/api.js"></script>
    <script src="../../js/vue.js"></script>
    <script src="../../js/hui.js"></script>
    <script src="../../js/common.js"></script>
    <script>
        apiready = function(){
            Vue.component('v-loading',{
                template:'<div class="loading" :style="bgopt"><div class="middlews"><span class="left"></span><span class="right"></span></div></div>',
                props:['opt'],
                computed:{
                    bgopt:function(){
                        return {
                            backgroundColor:"rgba(255,255,255,"+this.opt+")"
                        }
                    }
                }
            })
            //  无数据组件
            Vue.component('no-data',{
                template:'<div class="no-data"><img src="../../image/no_data.png"><div class="no-data-text"><div class="text">{{ msg }}</div><div class="btn fn-ctr" @click="pageBack"><span>返回</span></div></div></div>',
                data:function(){
                    return {}
                },
                methods:{
                    pageBack:function(){
                        api.closeWin()
                    }
                },
                props:{
                    msg:{type:String,default:'暂无数据'}
                }
            })
            var root = new Vue({
                el:"#root",
                data:{
                    opt:1,
                    loading:true,
                    orderList:[],
                    total:0,
                    isTotal:true,
                    currentOrderType:0,
                    headerNavType:-1,
                    headerNavBox:false,
                    nodata:false,
                },
                mounted:function(){
                    var _this = this;
                    if (api.statusBarAppearance) {
                        var safeArea = api.safeArea.top;
                        var search = document.querySelector('.header');  
                        var middle = document.querySelector('.middle');
                        var hnav   = document.querySelector('.header_nav');
                        var searchHeight = search.clientHeight;

                        var biaoti = document.getElementsByClassName('biaoti');
                        for (var i = 0; i < biaoti.length; i++) {
                            var bitaotiHeight = biaoti[i].clientHeight;
                            biaoti[i].style.top = safeArea + searchHeight + "px";
                        }

                        search.style.height = searchHeight+safeArea+"px";
                        search.style.paddingTop = safeArea + "px";
                        middle.style.paddingTop = safeArea+searchHeight + bitaotiHeight+ 45 + "px";
                        hnav.style.top  = safeArea + searchHeight + "px";
                    };
                    // init 默认  
                    _this.headerNavType = api.pageParam.headerNavType || -1;
                    _this.getOrderList();
                    // 下拉刷新
                    api.setCustomRefreshHeaderInfo({
                        bgColor : '#fff',
                        images : ['widget://image/dropdown_anim_00.png', 'widget://image/dropdown_anim_01.png', 'widget://image/dropdown_anim_02.png', 'widget://image/dropdown_anim_03.png', 'widget://image/dropdown_anim_04.png', 'widget://image/dropdown_anim_05.png', 'widget://image/dropdown_anim_06.png','widget://image/dropdown_anim_07.png','widget://image/dropdown_anim_08.png','widget://image/dropdown_anim_09.png','widget://image/dropdown_anim_10.png'],
                        tips : {
                            pull : '下拉刷新',
                            threshold : '松开立即刷新',
                            load : '正在刷新'
                        }
                    }, function() {
                        //下拉刷新被触发，自动进入加载状态，使用 api.refreshHeaderLoadDone() 手动结束加载中状态
                        //下拉刷新被触发，使用 api.refreshHeaderLoadDone() 结束加载中状态
                        _this.orderList.splice(0);
                        _this.getOrderList()
                    });
                    hui.lazyLoad();   //图片懒加载
                    hui.lazyLoadNow()
                    //上拉加载
                    var timp = "";
                    api.addEventListener({
                    　　name:'scrolltobottom',
                        extra:{threshold:20}
                    }, function(ret, err){
                　　　　　　//上拉加载时需要加载的数据
                        if (_this.orderList.length == _this.isTotal) {
                            // api.toast({msg:"到底了"})
                        }else{
                            clearTimeout(timp)
                            timp = setTimeout(function(){
                                _this.getOrderList();
                            },300)
                        }
                    });
                    api.addEventListener({name:"refreshOrder"},function(){_this.orderList.splice(0);_this.getOrderList()}) //监听刷新订单
                },
                methods:{
                    //打开选择类型盒子
                    openHeaderNav:function(){
                        this.headerNavBox = !this.headerNavBox;
                    },
                    closeHeaderNav:function(){
                        this.headerNavBox = false;
                    },
                    changeHeaderNav:function(index){
                        this.headerNavType = index;
                        this.orderList.splice(0);
                        this.getOrderList();
                        this.closeHeaderNav();
                    },
                    changeOrderType:function(type){
                        var _this = this;
                        _this.currentOrderType = type;
                        _this.loading = false;
                        _this.orderList.splice(0);
                        _this.getOrderList()
                    },
                    getOrderList:function(){
                        var _this = this;
                        if (!_this.isTotal) {
                            return false 
                        }
                        _this.isTotal = false;
                        request('/my/my_order',{
                            start:_this.orderList.length,
                            category_id:_this.headerNavType + 1,
                            order_status:_this.currentOrderType,
                        },function(err,res){
                            _this.isTotal = true;
                            api.refreshHeaderLoadDone()
                            setTimeout(function(){
                                _this.loading = false;
                            }, 700);
                            _this.isOrderDt()
                            if(!err && res.code == 1){
                                _this.orderList = _this.orderList.concat(res.data.data);
                                _this.total = res.data.total;
                            }
                        })
                    },
                    btnOpt:function(type,index){
                        var _this = this;
                        if (type == 1) { //去付款
                            api.openWin({
                                name:"payType",
                                url:"../user/pay_type.html",
                                pageParam:{
                                    orderno:_this.orderList[index].order_id,
                                    source:2,
                                }
                            })
                        }else if(type == 2){ //取消订单
                            _this.loading = true;
                            _this.opt = '.65';
                            request('/my/order_quxiao.html',{order_id:_this.orderList[index].order_id},function(err,res){
                                _this.loading = false;
                                if (!err && res.code == 1) {
                                    _this.orderList.splice(0);
                                    _this.getOrderList()
                                }else{
                                    err ? console.log('/my/order_quxiao500') : api.toast({msg:res.msg});
                                }
                            })
                        }else if(type == 3){ //确认收货
                            _this.loading = true;
                            _this.opt = '.65';
                            request('/my/order_shouhuo',{order_id:_this.orderList[index].order_id},function(err,res){
                                _this.loading = false;
                                if (!err && res.code == 1) {
                                    _this.orderList.splice(0);
                                    _this.getOrderList();
                                } else {
                                    err ? console.log('/my/order_shouhuo500') : api.toast({msg:res.msg})
                                }
                            })
                        }else if(type == 4){  //删除订单
                            var dialogBox = api.require('dialogBox');
							dialogBox.alert({
								texts: {
									title: '提示',
									content: '确认删除订单吗',
									leftBtnTitle: '取消',
									rightBtnTitle: '确认'
								},
								styles: {
									bg: '#fff',
									w: 300,
									corner:5,
									title: {
										marginT: 20,
										icon: 'widget://res/gou.png',
										iconSize: 40,
										titleSize: 14,
										titleColor: '#000'
									},
									content: {
										color: '#000',
										size: 14
									},
									left: {
										marginB: 7,
										marginL: 20,
										w: 130,
										h: 35,
										corner: 5,
										bg: '#ccc',
										color:'#fff',
										size: 12
									},
									right: {
										marginB: 7,
										marginL: 10,
										w: 130,
										h: 35,
										corner: 5,
										bg: '#0086F7',
										color:'#fff',
										size: 12
									},
								}
							}, function(ret) {
								if (ret.eventType == 'right') {
                                    _this.loading = true;
                                    _this.opt = '.65';
                                    request('/my/order_delete',{order_id:_this.orderList[index].order_id},function(err,res){
                                        _this.loading = false;
                                        if (!err && res.code == 1) {
                                            _this.orderList.splice(0);
                                            _this.getOrderList();
                                            api.sendEvent({name:"refreshUserInfo"})
                                        }else{
                                            err ? console.log('/my/order_delete500') : api.toast({msg:res.msg})
                                        }
                                    })   
								}
								dialogBox.close({
									dialogName: 'alert'
								});
							});
                        }
                    },
                    openOrderDtl:function(index){
                        var _this = this;
                        api.openWin({
                            name:"orderDetail",
                            url:"../mohan/order_detail.html",
                            pageParam:{
                                order_id:_this.orderList[index].order_id
                            }
                        })
                    },
                    isOrderDt:function(){
                        var _this = this;
                        setTimeout(function(){
                            _this.orderList.length == 0 ? _this.nodata = true : _this.nodata = false;
                        },150);
                    },
                    back:function(){
                        api.closeWin();
                    }
                },
                computed:{
                    hdNavTop:function(){
                        return this.headerNavBox ? '2.81rem' : "0";
                    }
                }
            })
        }
    
     
    
    </script>

</body>

</html>